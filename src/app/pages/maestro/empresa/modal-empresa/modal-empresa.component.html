<p-dialog [header]="isReadOnly ? 'Consulta de Empresa' : (dataToEdit ? 'Editar Empresa' : 'Nuevo Registro')"
    [(visible)]="visible" [modal]="true" [style]="{ width: '50rem' }" (onHide)="close()">

    <div class="wizard-steps-container" *ngIf="!dataToEdit && !isReadOnly">
        <p-steps [model]="steps()" [activeIndex]="currentStep()"></p-steps>
    </div>

    <form [formGroup]="wizardForm" class="form-container">

        <div *ngIf="currentStep() === 0 || isReadOnly" formGroupName="empresa" class="step-fade">
            <h3 class="step-title">{{ dataToEdit ? 'Actualizar Información Fiscal' : '1. Información de la Empresa' }}
            </h3>

            <div class="field flex-1">
                <label class="label-noir">N° Documento (RUC)</label>
                <div class="p-inputgroup">
                    <input pInputText formControlName="ruc" class="noir-input" maxlength="11" placeholder="11 dígitos"
                        (keyup.enter)="consultarRuc()" />
                    <button type="button" class="btn-search" (click)="consultarRuc()" [disabled]="loading()">
                        <i class="bi bi-search" *ngIf="!loading()"></i>
                        <i class="bi bi-arrow-repeat spin" *ngIf="loading()"></i> </button>
                </div>
                <small class="error-text" *ngIf="isFieldInvalid('empresa.ruc')">RUC debe tener 11 números.</small>
            </div>

            <div class="field-row">
                <div class="field flex-2">
                    <label class="label-noir">Razón Social</label>
                    <input pInputText formControlName="razonSocial" class="noir-input"
                        [class.ng-invalid]="isFieldInvalid('empresa.razonSocial')" />
                </div>
            </div>

            <div class="field">
                <label class="label-noir">Dirección Fiscal</label>
                <input pInputText formControlName="direccionFiscal" class="noir-input"
                    [class.ng-invalid]="isFieldInvalid('empresa.direccionFiscal')" />
            </div>

            <div>
                <div class="field-row">
                    <div class="field flex-1">
                        <label class="label-noir">Teléfono Corporativo</label>
                        <input pInputText formControlName="telefono" class="noir-input" placeholder="Ej: 912345678"
                            maxlength="9" />
                        <small class="error-text" *ngIf="isFieldInvalid('empresa.telefono')">Teléfono inválido.</small>
                    </div>
                    <div class="field flex-1">
                        <label class="label-noir">Email de Contacto</label>
                        <input pInputText formControlName="email" class="noir-input"
                            placeholder="ejemplo@corporacion.com" />
                        <small class="error-text" *ngIf="isFieldInvalid('empresa.email')">Email inválido.</small>
                    </div>
                </div>
            </div>

            <div class="field flex-1">
                <label class="label-noir">Logo</label>
                <div class="logo-uploader" (click)="fileInput.click()">
                    <img *ngIf="previewLogo()" [src]="previewLogo()" class="preview-img">
                    <div *ngIf="!previewLogo()" class="upload-placeholder">
                        <i class="bi bi-image"></i> <span>Subir Logo</span>
                    </div>
                    <input #fileInput type="file" (change)="onFileSelected($event)" hidden accept="image/*">
                </div>
            </div>
        </div>

        <div *ngIf="!dataToEdit && currentStep() === 1" formGroupName="sucursal" class="step-fade">
            <h3 class="step-title">2. Detalles de la Sede Principal</h3>
            <div class="field">
                <label class="label-noir">Nombre Comercial de la Sede</label>
                <input pInputText formControlName="nombre" class="noir-input" placeholder="Ej: Central Moyobamba" />
                <small class="error-text" *ngIf="isFieldInvalid('sucursal.nombre')">Rellene el nombre de la
                    sede.</small>
            </div>
            <div class="field-row">
                <div class="field flex-2">
                    <label class="label-noir">Dirección Física</label>
                    <input pInputText formControlName="direccion" class="noir-input" placeholder="Jr. Amorarca 712" />
                    <small class="error-text" *ngIf="isFieldInvalid('sucursal.direccion')">Rellene la dirección
                        física.</small>
                </div>
                <div class="field flex-1">
                    <label class="label-noir">Teléfono Sede</label>
                    <input pInputText formControlName="telefono" class="noir-input" maxlength="9"
                        placeholder="Ej: 912345678" />
                    <small class="error-text" *ngIf="isFieldInvalid('sucursal.telefono')">Teléfono inválido.</small>
                </div>
            </div>
        </div>

        <div *ngIf="!dataToEdit && currentStep() === 2" formGroupName="usuario" class="step-fade">
            <h3 class="step-title">3. Credenciales del Administrador</h3>

            <div class="field flex-1">
                <label class="label-noir">N° Documento (DNI)</label>
                <div class="p-inputgroup">
                    <input pInputText formControlName="numeroDocumento" class="noir-input" maxlength="8"
                        placeholder="8 dígitos" (keyup.enter)="consultarDni()" />
                    <button type="button" class="btn-search" (click)="consultarDni()" [disabled]="loading()">
                        <i class="bi bi-search" *ngIf="!loading()"></i>
                        <i class="bi bi-arrow-repeat spin" *ngIf="loading()"></i> </button>
                </div>
                <small class="error-text" *ngIf="isFieldInvalid('numeroDocumento')">DNI debe tener 8 números.</small>
            </div>

            <div class="field-row">
                <div class="field flex-1">
                    <label class="label-noir">Nombres</label>
                    <input pInputText formControlName="nombres" class="noir-input" />
                </div>
                <div class="field flex-1">
                    <label class="label-noir">Ap. Paterno</label>
                    <input pInputText formControlName="apellidoPaterno" class="noir-input" />
                </div>
                <div class="field flex-1">
                    <label class="label-noir">Ap. Materno</label>
                    <input pInputText formControlName="apellidoMaterno" class="noir-input" />
                </div>
            </div>

            <div class="field-row">
                <div class="field flex-1">
                    <label class="label-noir">Teléfono Personal</label>
                    <input pInputText formControlName="telefono" class="noir-input" maxlength="9"
                        placeholder="Ej: 912345678" [class.ng-invalid]="isFieldInvalid('usuario.telefono')" />
                    <small class="error-text" *ngIf="isFieldInvalid('usuario.telefono')">Teléfono inválido.</small>
                </div>
                <div class="field flex-1">
                    <label class="label-noir">Email Personal</label>
                    <input pInputText formControlName="email" class="noir-input" placeholder="prueba@corporacion.com"
                        [class.ng-invalid]="isFieldInvalid('usuario.email')" />
                    <small class="error-text" *ngIf="isFieldInvalid('usuario.email')">Email inválido.</small>
                </div>
            </div>

            <div class="field-row">
                <div class="field flex-1">
                    <label class="label-noir">Usuario (Login)</label>
                    <input pInputText formControlName="username" class="noir-input" />
                    <small class="error-text" *ngIf="isFieldInvalid('usuario.username')">Digite un nombre de
                        usuario.</small>
                </div>
                <div class="field flex-1">
                    <label class="label-noir">Password</label>
                    <input pInputText type="password" formControlName="password" class="noir-input" />
                    <small class="error-text" *ngIf="isFieldInvalid('usuario.password')">Digite una contraseña.</small>
                </div>
            </div>
        </div>

        <div class="footer-actions">
            <button type="button" class="btn-cancel" *ngIf="dataToEdit || currentStep() === 0" (click)="close()">
                {{ dataToEdit ? 'Cancelar' : 'Cerrar' }}
            </button>

            <button type="button" class="btn-cancel" *ngIf="!dataToEdit && currentStep() > 0" (click)="prevStep()">
                <i class="bi bi-arrow-left"></i> Atrás
            </button>

            <div class="spacer"></div>

            <button type="button" class="btn-save" *ngIf="!dataToEdit && currentStep() < 2" (click)="nextStep()">
                Siguiente <i class="bi bi-arrow-right"></i>
            </button>

            <button type="button" class="btn-save" *ngIf="dataToEdit || currentStep() === 2" (click)="saveAll()"
                [disabled]="loading()">
                <i class="bi bi-check-circle" *ngIf="!loading()"></i>
                {{ loading() ? 'Procesando...' : (dataToEdit ? 'Guardar Cambios' : 'Finalizar y Crear') }}
            </button>
        </div>
    </form>
</p-dialog>