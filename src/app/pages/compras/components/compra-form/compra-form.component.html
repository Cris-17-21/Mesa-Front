<div class="compra-page">
    <p-toast></p-toast>

    <div class="compra-header">
        <h2>Nueva Compra</h2>
        <button type="button" class="btn-cancel-header" (click)="onCancel()">Ã—</button>
    </div>

    <form [formGroup]="form" (ngSubmit)="onSubmit()">

        <!-- ===== DETALLES DE LA COMPRA ===== -->
        <div class="seccion-card">
            <div class="seccion-titulo">
                <span class="icono">ðŸªª</span>
                <h3>Detalles de la Compra</h3>
            </div>
            <hr class="linea-roja" />

            <div class="form-grid">
                <!-- Proveedor -->
                <div class="field col-2">
                    <label>Proveedor</label>
                    <div class="proveedor-wrapper">
                        <input type="text" class="campo-input"
                            placeholder="Escribe para buscar por razÃ³n social, nombre com..."
                            [(ngModel)]="proveedorBusqueda" [ngModelOptions]="{standalone: true}"
                            (input)="filtrarProveedores()" (focus)="filtrarProveedores()" autocomplete="off" />
                        <button *ngIf="selectedProveedor" type="button" class="btn-clear"
                            (click)="limpiarProveedor()">Ã—</button>

                        <div class="proveedor-dropdown" *ngIf="showProveedorList && proveedoresFiltrados.length > 0">
                            <div class="prov-item" *ngFor="let p of proveedoresFiltrados"
                                (click)="seleccionarProveedor(p)">
                                <strong>{{ p.razonSocial }}</strong>
                                <small>RUC {{ p.ruc }} Â· {{ p.telefono }}</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- RUC Proveedor -->
                <div class="field col-2">
                    <label>RUC del Proveedor</label>
                    <input type="text" class="campo-input" readonly [value]="selectedProveedor?.ruc || ''"
                        placeholder="Ej: 20123456789" />
                </div>

                <!-- Fecha Pedido -->
                <div class="field">
                    <label>Fecha de Pedido *</label>
                    <input type="date" class="campo-input" [value]="today" readonly />
                </div>

                <!-- Fecha Entrega -->
                <div class="field">
                    <label>Fecha Entrega Esperada</label>
                    <input type="date" class="campo-input" formControlName="fechaEntregaEsperada" />
                </div>

                <!-- MÃ©todo de Pago -->
                <div class="field">
                    <label>MÃ©todo de Pago</label>
                    <select class="campo-input" formControlName="idTipoPago">
                        <option [ngValue]="null">Seleccionar mÃ©todo</option>
                        <option *ngFor="let t of tiposPago" [ngValue]="t.idTipoPago">{{ t.tipoPago }}</option>
                    </select>
                </div>

                <!-- Referencia -->
                <div class="field">
                    <label>Referencia/NÂ° CotizaciÃ³n</label>
                    <input type="text" class="campo-input" formControlName="referencia"
                        placeholder="Ej: COT-2025-001" />
                </div>

                <!-- Observaciones (full width) -->
                <div class="field col-full">
                    <label>Observaciones</label>
                    <textarea class="campo-input" rows="3" formControlName="observaciones"
                        placeholder="Notas adicionales..."></textarea>
                </div>
            </div>
        </div>

        <!-- ===== PRODUCTOS DE LA COMPRA ===== -->
        <div class="seccion-card">
            <div class="seccion-titulo">
                <span class="icono">ðŸ“¦</span>
                <h3>Productos de la Compra</h3>
            </div>
            <hr class="linea-roja" />

            <!-- Filas de detalle -->
            <div formArrayName="detalles">
                <div class="detalle-row" *ngFor="let ctrl of detalles.controls; let i = index" [formGroupName]="i">
                    <div class="detalle-grid">
                        <!-- Producto selector -->
                        <div class="field detalle-producto">
                            <label>Producto</label>
                            <select class="campo-input" formControlName="idProducto" (change)="onProductoChange(i)">
                                <option [ngValue]="null">{{ selectedProveedor ? 'Seleccionar producto...' : 'Primero
                                    seleccione un proveedor' }}</option>
                                <option *ngFor="let p of productosFiltrados" [ngValue]="p.idProducto">{{
                                    p.nombreProducto }}</option>
                            </select>
                        </div>

                        <!-- Cantidad -->
                        <div class="field detalle-cant">
                            <label>Cantidad</label>
                            <input type="number" class="campo-input" formControlName="cantidadPedida" min="1" />
                        </div>

                        <!-- Costo unitario -->
                        <div class="field detalle-precio">
                            <label>Costo Unit.</label>
                            <input type="number" class="campo-input" formControlName="costoUnitario" min="0"
                                step="0.01" />
                        </div>

                        <!-- Subtotal -->
                        <div class="field detalle-sub">
                            <label>Subtotal</label>
                            <input type="text" class="campo-input subtotal-readonly" readonly
                                [value]="'S/ ' + (ctrl.get('subtotalLinea')?.value | number:'1.2-2')" />
                        </div>

                        <!-- Eliminar -->
                        <div class="field detalle-del">
                            <label>&nbsp;</label>
                            <button type="button" class="btn-eliminar" (click)="quitarProducto(i)"
                                title="Eliminar producto">
                                ðŸ—‘
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <button type="button" class="btn-agregar-producto" (click)="agregarProducto()">
                + Agregar Producto
            </button>

            <!-- IGV Toggle -->
            <div class="igv-row">
                <label class="switch-label">
                    <div class="toggle-track" [class.on]="aplicaIgv" (click)="aplicaIgv = !aplicaIgv">
                        <div class="toggle-thumb"></div>
                    </div>
                    <div>
                        <strong>Aplicar IGV (18%)</strong>
                        <div class="igv-hint">Divide el importe total entre 1.18 para obtener la base imponible</div>
                    </div>
                </label>
            </div>

            <!-- Totales -->
            <div class="totales-section">
                <div class="total-row">
                    <span>Subtotal:</span>
                    <span>S/ {{ subtotal | number:'1.2-2' }}</span>
                </div>
                <div class="total-row" *ngIf="aplicaIgv">
                    <span>IGV (18%):</span>
                    <span>S/ {{ igvAmount | number:'1.2-2' }}</span>
                </div>
                <hr />
                <div class="total-row total-final">
                    <span><strong>Total:</strong></span>
                    <span><strong>S/ {{ total | number:'1.2-2' }}</strong></span>
                </div>
            </div>
        </div>

        <!-- ===== ACCIONES ===== -->
        <div class="acciones-footer">
            <button type="button" class="btn-sec" (click)="onCancel()">Cancelar</button>
            <button type="submit" class="btn-primary" [disabled]="enviando">
                {{ enviando ? 'Guardando...' : 'Guardar Compra' }}
            </button>
        </div>

    </form>
</div>

<!-- Click outside closes proveedor dropdown -->
<div class="overlay-transparent" *ngIf="showProveedorList" (click)="showProveedorList = false"></div>